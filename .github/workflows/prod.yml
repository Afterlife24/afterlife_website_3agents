name: Deploy Next.js 13 App to AWS Lambda + CloudFront

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      S3_BUCKET_STATIC: ${{ secrets.S3_BUCKET_STATIC }}
      LAMBDA_FUNCTION_NAME: ${{ secrets.LAMBDA_FUNCTION_NAME }}
      CLOUDFRONT_DIST_ID: ${{ secrets.CLOUDFRONT_DIST_ID }}

    steps:
      # 1️⃣ Checkout repo
      - uses: actions/checkout@v3

      # 2️⃣ Setup Node.js
      - uses: actions/setup-node@v3
        with:
          node-version: 18

      # 3️⃣ Install dependencies
      - run: npm install --legacy-peer-deps

      # 4️⃣ Build Next.js
      - run: npx next build

      # 5️⃣ Upload static assets to S3
      - run: |
          aws s3 sync .next/static s3://$S3_BUCKET_STATIC/_next/static --delete
          aws s3 sync public s3://$S3_BUCKET_STATIC/ --delete
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # 6️⃣ Package SSR Lambda
      - run: |
          mkdir lambda-package
          cp -r .next/standalone/* lambda-package/
          # Add Lambda handler
          cat << 'EOF' > lambda-package/index.js
          const { default: handler } = require("./server/index.js");
          exports.handler = async (event, context) => {
            return handler(event, context);
          };
          EOF
          cd lambda-package
          zip -r ../next-lambda.zip .
        shell: bash

      # 7️⃣ Create or update Lambda function automatically
      - run: |
          FUNCTION_EXISTS=$(aws lambda get-function --function-name $LAMBDA_FUNCTION_NAME --region $AWS_REGION || echo "false")
          if [ "$FUNCTION_EXISTS" = "false" ]; then
            aws lambda create-function \
              --function-name $LAMBDA_FUNCTION_NAME \
              --runtime nodejs18.x \
              --role ${{ secrets.AWS_LAMBDA_ROLE_ARN }} \
              --handler index.handler \
              --zip-file fileb://next-lambda.zip \
              --region $AWS_REGION
          else
            aws lambda update-function-code \
              --function-name $LAMBDA_FUNCTION_NAME \
              --zip-file fileb://next-lambda.zip \
              --region $AWS_REGION
          fi
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # 8️⃣ Invalidate CloudFront
      - run: |
          aws cloudfront create-invalidation \
            --distribution-id $CLOUDFRONT_DIST_ID \
            --paths "/*"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}